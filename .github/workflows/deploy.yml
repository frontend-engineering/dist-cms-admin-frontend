name: Deploy
on:
  push:
jobs:
  deploy:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v3

      - id: now
        run: echo "::set-output name=now::$(date +'%Y-%m-%dT%H.%M.%S')"

      - run: tar -czf ${{ runner.temp }}/${{ steps.now.outputs.now }}-${{ github.sha }}.tar.gz .

      - uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.now.outputs.now }}-${{ github.sha }}
          path: ${{ runner.temp }}/${{ steps.now.outputs.now }}-${{ github.sha }}.tar.gz

      - name: Deploy to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          source: ${{ runner.temp }}/${{ steps.now.outputs.now }}-${{ github.sha }}.tar.gz
          target: "$HOME/cms"
